<section class="back-button-container">
  <button mat-raised-button color="primary" class="back-button" (click)="goBack()">Powrót do listy dań</button>
</section>
<section class="dish-detail-container"
         *ngIf="dish !== undefined && orderDetailsService.orders[dish.name] !== undefined">
  <div class="pictures-container">
    <picture>
      <source media="(max-width): 600px" srcset="{{dish.pictures[2]}}">
      <source media="(max-width): 800px" srcset="{{dish.pictures[1]}}">
      <img src="{{dish.pictures[0]}}" alt="picture1">
    </picture>
    <picture>
      <source media="(max-width): 600px" srcset="{{dish.pictures[5]}}">
      <source media="(max-width): 800px" srcset="{{dish.pictures[4]}}">
      <img src="{{dish.pictures[3]}}" alt="picture2">
    </picture>
  </div>
  <div class="info-container">
    <h1 class="title">{{dish.name | uppercase}}</h1>
    <div class="underline"></div>
    <div class="description">
      {{dish.description}}
    </div>
    <div class="underline"></div>
    <div class="ingredients" *ngFor="let category of dish.typeAndCategory">
      | {{category | uppercase}} |
    </div>
    <div class="underline"></div>
    <div class="categories">
      <span class="bold">Składniki:</span>
      <ul>
        <li *ngFor="let ingredients of dish.ingredients">{{ingredients}}</li>
      </ul>
    </div>
    <div class="underline"></div>
    <div class="price">
      <span
        class="bold">Cena: </span>{{orderDetailsService.roundNum(dish.price * orderDetailsService.exchangeRate)}}
      {{orderDetailsService.currCurrency}}
    </div>
    <div class="underline"></div>
    <div class="rating">
      <div *ngIf="!roleService.userBanStatus[authService.user!.uid]; else bannedUser">
        <div *ngIf="roleService.canRateDishes(); else manager">
          <div *ngIf="!authService.userRatedDishes.includes(dish.name); else alreadyRated">
            <div class="reviews" *ngIf="authService.checkPrevOrders(dish.name); else notOrdered">
              Ocena:
              <span [ngClass]="{'checked': ratingService.ratings[dish.name] >= 1}" class="fa fa-star"
                    (click)="ratingService.updateRating(dish, 1)"></span>
              <span [ngClass]="{'checked': ratingService.ratings[dish.name] >= 2}" class="fa fa-star"
                    (click)="ratingService.updateRating(dish, 2)"></span>
              <span [ngClass]="{'checked': ratingService.ratings[dish.name] >= 3}" class="fa fa-star"
                    (click)="ratingService.updateRating(dish, 3)"></span>
              <span [ngClass]="{'checked': ratingService.ratings[dish.name] >= 4}" class="fa fa-star"
                    (click)="ratingService.updateRating(dish, 4)"></span>
              <span [ngClass]="{'checked': ratingService.ratings[dish.name] >= 5}" class="fa fa-star"
                    (click)="ratingService.updateRating(dish, 5)"></span>
            </div>
            <ng-template #notOrdered>
              <h3>Aby móc ocenić to danie, należy najpierw je zamówić.</h3>
            </ng-template>
          </div>
          <ng-template #alreadyRated>
            <h3>To danie zostało już przez ciebie ocenione.</h3>
          </ng-template>
        </div>
        <ng-template #manager>
          <h3>Menadżer nie może oceniać dań.</h3>
        </ng-template>
      </div>
      <ng-template #bannedUser>
        <h3>Nie możesz oceniać dań, ponieważ zostałeś zbanowany!</h3>
      </ng-template>
      <div *ngIf="ratingService.numOfRatings != 0; else noRatings" class="stars-cnt">
        <p>Średnia ocena: {{ratingService.meanRatings[dish.name]}}</p>
        <p>Liczba ocen: {{ratingService.allRatings[dish.name].length}}</p>
      </div>
      <ng-template #noRatings>Brak ocen</ng-template>
    </div>
    <div class="underline"></div>
    <div class="buttons-and-cnt">
      <div class="dish-buttons-container">
        <button mat-mini-fab color="warn"
                (click)="orderDetailsService.removeOrder(dish)"
                [disabled]="!roleService.canOrder() || orderDetailsService.checkIfMinDishCnt(dish)"
        >
          <mat-icon>remove</mat-icon>
        </button>
        <span class="num-of-orders">{{orderDetailsService.orders[dish.name][0]}}</span>
        <button mat-mini-fab color="warn"
                (click)="orderDetailsService.addOrder(dish)"
                [disabled]="!roleService.canOrder() || orderDetailsService.checkIfMaxDishCnt(dish)"
        >
          <mat-icon>add</mat-icon>
        </button>
      </div>
      <div class="dish-message" *ngIf="orderDetailsService.orders[dish.name][0] !== dish.maxDishesPerDay"
           [ngClass]="{'few-dishes': dish.maxDishesPerDay - orderDetailsService.orders[dish.name][0] < 4}">Liczba
        dostępnych
        dań: {{dish.maxDishesPerDay - orderDetailsService.orders[dish.name][0]}}</div>
      <div class="dish-message" *ngIf="orderDetailsService.orders[dish.name][0] === dish.maxDishesPerDay">Wybrano
        maksymalną liczbę
        dań!
      </div>
    </div>
    <div class="underline"></div>
    <div class="form-href">
      <p>Recenzje dania</p>
      <p class="scroll-arrow" (click)="scroll(reviewsContainer)">↓</p>
    </div>
  </div>
</section>
<section class="reviews-container">
  <div *ngIf="!roleService.userBanStatus[authService.user!.uid]; else bannedUser">
    <div *ngIf="roleService.canReviewDishes(); else wrongRole">
      <div *ngIf="!authService.userReviewedDishes.includes(dish.name); else alreadyReviewed">
        <div *ngIf="authService.checkPrevOrders(dish.name); else notOrdered">
          <form class="form-container"
                #addReviewDirective="ngForm"
                [formGroup]="reviewForm"
                (ngSubmit)="onSubmit(addReviewDirective)">
            <h2>Dodaj nową recenzję:</h2>
            <mat-form-field appearance="fill">
              <mat-label>Nick</mat-label>
              <input matInput id="nick" type="text" formControlName="nick" required>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Nazwa</mat-label>
              <input matInput id="name" type="text" formControlName="name" required>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Opis</mat-label>
              <textarea matInput id="description" type="text" formControlName="description" required></textarea>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Data (opcjonalnie)</mat-label>
              <input matInput formControlName="date" [matDatepicker]="picker">
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>

            <div class="button-container">
              <button mat-raised-button type="submit">Dodaj recenzję</button>
            </div>
          </form>
          <app-messages></app-messages>
        </div>
        <ng-template #notOrdered>
          <h3>Aby móc zrecenzować to danie, należy najpierw je zamówić.</h3>
        </ng-template>
      </div>
      <ng-template #alreadyReviewed>
        <h3>To danie zostało już przez ciebie zrecenzowane.</h3>
      </ng-template>
    </div>
    <ng-template #wrongRole>Nie masz odpowiednich uprawnień do dodania recenzji.</ng-template>
  </div>
  <ng-template #bannedUser>
    <h3>Nie możesz dodawać recenzji, ponieważ zostałeś zbanowany!</h3>
  </ng-template>
  <div class="added-reviews" #reviewsContainer>
    <h1 class="title">Recenzje</h1>
    <div class="underline"></div>
    <h2 *ngIf="!this.reviews.length">Brak recenzji. Bądź pierwszym, który oceni to danie!</h2>
    <div class="added-reviews-container" *ngIf="this.reviews.length">
      <div class="review-name">{{currReview.name | uppercase}}</div>
      <div class="quote-signs">&#10078;</div>
      <div class="review-description">
        {{currReview.description}}
      </div>
      <div class="review-nick">
        ~ {{currReview.nick}}
      </div>
      <div class="review-date" *ngIf="currReview.date !== null">
        {{currReview.date}}
      </div>
      <div class="arrows-container">
        <button class="left-arrow" (click)="leftArrow()">&#8249;</button>
        <button class="right-arrow" (click)="rightArrow()">&#8250;</button>
      </div>
      <button mat-raised-button color="accent" (click)="randomReview()">Losowa recenzja</button>
    </div>
  </div>
</section>
